@page "/reviews/{id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using HealthIsWealth.Domain
@using HealthIsWealth.Data
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@implements IAsyncDisposable
@inject IDbContextFactory<HealthIsWealth.Data.HealthIsWealthContext> DbFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Booking Reviews</PageTitle>

<div class="full-screen-bg"></div>

<div class="review-container">

    <div class="review-header-card">
        <div class="review-header-content">
            @if (relatedBooking != null)
            {
                <h1>@relatedBooking.Timeslot?.Facility?.Name</h1>
                <p>
                    <span style="opacity:0.7">Session on</span>
                    <strong>@relatedBooking.Timeslot?.StartDT.ToString("dd MMM yyyy, h:mm tt")</strong>
                </p>
                <p class="small opacity-75">Booking Ref: #@Id</p>
            }
            else
            {
                <h1>Booking #@Id</h1>
                <p>Loading details...</p>
            }

            <a href="@($"/reviews/create?bookingid={Id}")" class="header-action-btn">
                + Write a Review
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Loading reviews...</p>
        </div>
    }
    else if (reviews == null || !reviews.Any())
    {
        <div class="empty-state">
            <h3>No reviews yet 📝</h3>
            <p>How was your experience? Be the first to leave feedback!</p>
        </div>
    }
    else
    {
        <div class="review-list">
            @foreach (var review in reviews)
            {
                <div class="review-card">

                    <div class="review-top-row">
                        <div class="star-rating" title="Rating: @review.Rating / 5">
                            @RenderStars(review.Rating)
                        </div>

                        <div class="reviewer-name">
                            @if (review.User != null)
                            {
                                <span>@review.User.FirstName @review.User.LastName</span>
                            }
                            else
                            {
                                <span>User #@review.UserId</span>
                            }
                        </div>
                    </div>

                    <p class="review-text">"@review.Feedback"</p>

                    <div class="card-actions">
                        <a href="@($"reviews/details?reviewid={review.ReviewId}")" class="btn-action btn-details">View Details</a>

                        @if (review.UserId == currentUserId)
                        {
                            <a href="@($"reviews/edit?reviewid={review.ReviewId}")" class="btn-action btn-edit">Edit</a>
                            <a href="@($"reviews/delete?reviewid={review.ReviewId}")" class="btn-action btn-delete">Delete</a>
                        }
                    </div>
                </div>
            }
        </div>
    }

    <div class="mt-4">
        <a href="/bookings" class="text-secondary text-decoration-none">← Back to My Bookings</a>
    </div>

</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private HealthIsWealthContext context = default!;
    private List<Review>? reviews;
    private Booking? relatedBooking;
    private bool isLoading = true;

    // Store the ID of the person currently looking at the page
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        // 1. Get Current User ID
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            // Fetch the ID from the claims
            currentUserId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        }

        try
        {
            // 2. Fetch Booking Details
            relatedBooking = await context.Booking
                .Include(b => b.Timeslot)
                .ThenInclude(t => t.Facility)
                .FirstOrDefaultAsync(b => b.BookingId == Id);

            // 3. Fetch Reviews
            reviews = await context.Review
                .Include(r => r.User)
                .Where(r => r.BookingId == Id)
                .OrderByDescending(r => r.ReviewId)
                .ToListAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private MarkupString RenderStars(double rating)
    {
        int roundedRating = (int)Math.Round(rating);
        var stars = "";
        for (int i = 1; i <= 5; i++)
        {
            if (i <= roundedRating)
                stars += "★";
            else
                stars += "☆";
        }
        return new MarkupString(stars);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}