@page "/reviews/{id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using HealthIsWealth.Domain
@using HealthIsWealth.Data
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@implements IAsyncDisposable
@inject IDbContextFactory<HealthIsWealth.Data.HealthIsWealthContext> DbFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Booking Reviews</PageTitle>

<div class="bookings-container">

    <div class="bookings-header">
        @if (relatedBooking != null)
        {
            <h1>@relatedBooking.Timeslot?.Facility?.Name</h1>
            <p>
                <span style="opacity:0.8">Session on</span><br />
                <strong>@relatedBooking.Timeslot?.StartDT.ToString("dd MMM yyyy, h:mm tt")</strong>
            </p>
            <p class="booking-id">Booking Ref: #@Id</p>
        }
        else
        {
            <h1>Booking #@Id</h1>
            <p>Loading details...</p>
        }

        <div style="margin-top: 20px;">
            <a href="@($"/reviews/create?bookingid={Id}")" class="btn-action btn-details" style="display: inline-block; width: auto; min-width: 200px;">
                + Write a Review
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center mt-5" style="color: white;">
            <p>Loading reviews...</p>
        </div>
    }
    else if (reviews == null || !reviews.Any())
    {
        <div class="booking-card empty-state">
            <h4>No reviews yet 📝</h4>
            <p class="location-text">How was your experience? Be the first to leave feedback!</p>
        </div>
    }
    else
    {
        <div class="bookings-list">
            @foreach (var review in reviews)
            {
                <div class="booking-card" style="display: block;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">

                        <div class="star-rating" title="Rating: @review.Rating / 5">
                            @RenderStars(review.Rating)
                        </div>

                        <div class="reviewer-name">
                            @if (review.User != null)
                            {
                                <span>@review.User.FirstName @review.User.LastName</span>
                            }
                            else
                            {
                                <span>User #@review.UserId</span>
                            }
                        </div>
                    </div>

                    <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="font-style: italic; margin: 0; line-height: 1.5; color: rgba(255,255,255,0.9);">
                            "@review.Feedback"
                        </p>
                    </div>

                    <div class="card-actions">
                        <a href="@($"reviews/details?reviewid={review.ReviewId}")" class="btn-action btn-details">View Details</a>

                        @if (review.UserId == currentUserId)
                        {
                            <a href="@($"reviews/edit?reviewid={review.ReviewId}")" class="btn-action btn-reschedule">Edit</a>

                            <a href="@($"reviews/delete?reviewid={review.ReviewId}")" class="btn-action btn-cancel">Delete</a>
                        }
                    </div>

                </div>
            }
        </div>
    }

    <div class="text-center mt-4" style="padding-bottom: 20px;">
        <a href="/bookings" style="color: rgba(255,255,255,0.8); text-decoration: none; font-weight: 600;">
            ← Back to My Bookings
        </a>
    </div>

</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private HealthIsWealthContext context = default!;
    private List<Review>? reviews;
    private Booking? relatedBooking;
    private bool isLoading = true;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            currentUserId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        }

        try
        {
            relatedBooking = await context.Booking
                .Include(b => b.Timeslot)
                .ThenInclude(t => t.Facility)
                .FirstOrDefaultAsync(b => b.BookingId == Id);

            reviews = await context.Review
                .Include(r => r.User)
                .Where(r => r.BookingId == Id)
                .OrderByDescending(r => r.ReviewId)
                .ToListAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private MarkupString RenderStars(double rating)
    {
        int roundedRating = (int)Math.Round(rating);
        var stars = "";
        for (int i = 1; i <= 5; i++)
        {
            stars += (i <= roundedRating) ? "★" : "☆";
        }
        return new MarkupString(stars);
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}