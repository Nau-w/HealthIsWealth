@page "/venues/facility-booking/new-booking/{facilityId:int}/timeslots"
@using HealthIsWealth.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using HealthIsWealth.Domain
@using System.Security.Claims
@inject IDbContextFactory<HealthIsWealth.Data.HealthIsWealthContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Book Timeslots</PageTitle>

<div class="container my-4">
    <div class="mx-auto" style="max-width: 960px;">
        @if (facility is null)
        {
            <div class="d-flex align-items-center justify-content-center py-5">
                <div class="spinner-border text-danger me-3" role="status" aria-hidden="true"></div>
                <div>
                    <h5 class="mb-1">Loading facility...</h5>
                    <div class="text-muted">Please wait</div>
                </div>
            </div>
        }
        else
        {
            <div class="card shadow-sm mb-3">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="@(!string.IsNullOrWhiteSpace(facility.ThumbnailImageUrl) ? facility.ThumbnailImageUrl : facility.Venue?.ThumbnailImageUrl)"
                             onerror="this.onerror=null;this.src='/images/placeholder.png';"
                             class="img-fluid h-100 w-100 object-fit-cover rounded-start" alt="Facility image" />
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h2 class="h5 text-danger mb-1">@facility.Venue?.Name</h2>
                                    <h3 class="h6 text-muted mb-2">@facility.Name</h3>
                                    <p class="mb-1"><strong>Location:</strong> @facility.Location</p>
                                    <p class="mb-0"><strong>Price (per hour):</strong> @facility.Price.ToString("C")</p>
                                </div>
                                <div class="text-end">
                                    <a class="btn btn-outline-secondary btn-sm" href="/venues/facility-booking/new-booking/@facilityId">&lt; Back</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (inputModel is not null)
            {
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Confirm booking</h5>

                                <EditForm Model="@inputModel" OnValidSubmit="Submit">
                                    <CustomValidation @ref="timeslotValidation" />
                                    <ValidationSummary class="text-danger" />

                                    <div class="mb-3">
                                        <label for="timeslot" class="form-label">Booking timeslot</label>
                                        <InputSelect TValue="DateTime" id="timeslot" class="form-select"
                                                     @bind-Value="inputModel.startDT" aria-label="Select start time">
                                            @if (!AvailableStartTimes.Any())
                                            {
                                                <option disabled selected>— No available times —</option>
                                            }
                                            else
                                            {
                                                @foreach (var startDT in AvailableStartTimes)
                                                {
                                                    <option value="@startDT">@startDT.ToShortTimeString() — @startDT.AddHours(hours).ToShortTimeString()</option>
                                                }
                                            }
                                        </InputSelect>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Duration</label>
                                        <p class="mb-0"><strong>@hours</strong> hour(s)</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Total price</label>
                                        <p class="fs-5 fw-bold mb-0">@((facility.Price * hours).ToString("C"))</p>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-danger" disabled="@(AvailableStartTimes.Count == 0)">Book Timeslot</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>

                        @if (!AvailableStartTimes.Any())
                        {
                            <div class="alert alert-warning">
                                No contiguous timeslots are available for the selected date and duration. Try a different date or shorter duration.
                            </div>
                        }
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Booking summary</h6>
                                <dl class="row">
                                    <dt class="col-5">Venue</dt>
                                    <dd class="col-7">@facility.Venue?.Name</dd>

                                    <dt class="col-5">Facility</dt>
                                    <dd class="col-7">@facility.Name</dd>

                                    <dt class="col-5">Date</dt>
                                    <dd class="col-7">@date.ToString("MMM d, yyyy")</dd>

                                    <dt class="col-5">Hours</dt>
                                    <dd class="col-7">@hours</dd>

                                    <dt class="col-5">Price</dt>
                                    <dd class="col-7">@((facility.Price * hours).ToString("C"))</dd>
                                </dl>
                                <hr />
                                <p class="small text-muted mb-0">Bookings are subject to venue rules and availability. You will be redirected to your bookings page after confirmation.</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public int facilityId { get; set; }

    [SupplyParameterFromQuery(Name = "date")]
    public string? dateAsString { get; set; }

    [SupplyParameterFromQuery (Name="hours")]
    public int hours { get; set; }

    private InputModel inputModel;

    private DateOnly date;
    private DateTime endDT;

    private IList<DateTime> AvailableStartTimes = new List<DateTime>();

    private CustomValidation? timeslotValidation;

    private Facility? facility;

    private string? userId;

    private sealed class InputModel{
        public DateTime startDT;
    }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        facility = await context.Facility.Include(f=>f.Venue).FirstOrDefaultAsync(f => f.FacilityId == facilityId);
        DateOnly minDate = DateOnly.FromDateTime(DateTime.Today.AddDays(1));
        DateOnly maxDate = DateOnly.FromDateTime(DateTime.Today.AddDays(14));

        if (facility is null || dateAsString is null || !DateOnly.TryParseExact(dateAsString, "yyyy-MM-dd", out date) 
            || hours < 1 || hours > 4 || minDate > date || maxDate < date)
        {
            NavigationManager.NavigateTo("notfound");
        }

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst(c=>c.Type == ClaimTypes.NameIdentifier)?.Value;

        inputModel = new();
        await FindTimeslots(date, hours);
    }

    private async void Submit()
    {
        timeslotValidation?.ClearErrors();

        var errors = new Dictionary<string, List<string>>();

        endDT = inputModel.startDT.AddHours(hours);

        using var context = DbFactory.CreateDbContext();
        if (await context.Timeslot.Where(t => t.FacilityId == facilityId &&
            (t.StartDT >= inputModel.startDT && t.StartDT < endDT || 
            t.EndDT > inputModel.startDT && t.EndDT <= endDT)).AnyAsync())
        {
            errors.Add("timeslot", ["Timeslot is occupied."]);
        }
        if (errors.Any())
        {
            timeslotValidation?.DisplayErrors(errors);
            await FindTimeslots(date, hours);
            StateHasChanged();
        } else
        {
            await AddTimeslot();
        }

    }

    private async Task AddTimeslot()
    {
        using var context = DbFactory.CreateDbContext();
        Timeslot timeslot = new Timeslot
        {
            EndDT = endDT,
            StartDT = inputModel.startDT,
            FacilityId = facilityId,
        };
        context.Timeslot.Add(timeslot);
        await context.SaveChangesAsync();
        context.Booking.Add(new Booking
        {
            TimeslotId = timeslot.TimeslotId, 
            UserId = userId
        });
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/bookings");
    }

    private async Task FindTimeslots(DateOnly date, int hours)
    {
        if (AvailableStartTimes.Any())
        {
            inputModel.startDT = AvailableStartTimes.First();
        }

        using var context = DbFactory.CreateDbContext();
        IList<Timeslot> FilteredTimeslots = context.Timeslot.Where(t => t.FacilityId == facilityId &&
            DateOnly.FromDateTime(t.StartDT).Equals(date)).ToList();

        AvailableStartTimes = new List<DateTime>();
        int count = 0;

        // 7AM TO 10PM
        for (int i = 7; i < 22; i++)
        {
            count += count != hours ? 1 : 0;
            if (FilteredTimeslots.Any(t => t.StartDT.Hour <= i && i < t.EndDT.Hour))
            {
                count = 0;
            }
            if (count == hours)
            {
                AvailableStartTimes.Add(new DateTime(date, new TimeOnly(i-hours+1, 0, 0)));
            }
        }
        await Task.CompletedTask;
    }
}
