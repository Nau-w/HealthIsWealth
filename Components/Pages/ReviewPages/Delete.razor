@page "/reviews/delete"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using HealthIsWealth.Domain
@inject IDbContextFactory<HealthIsWealth.Data.HealthIsWealthContext> DbFactory
@inject NavigationManager NavigationManager
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Delete Review</PageTitle>

<div class="bookings-container">

    <div class="bookings-header">
        <h1>Delete Review</h1>
        <p>Are you sure you want to delete this?</p>
    </div>

    @if (review is null)
    {
        <div class="text-center mt-5" style="color: white;">
            <p>Loading...</p>
        </div>
    }
    else
    {
        <div class="booking-card" style="display: block; text-align: center; max-width: 600px; margin: 0 auto;">

            <div style="background: rgba(255, 0, 0, 0.15); border: 1px solid rgba(255, 0, 0, 0.3); color: #ffcccc; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
                <strong>Warning:</strong> This action cannot be undone.
            </div>

            <h5 style="color: white; margin-bottom: 15px;">Review for Booking #@review.BookingId</h5>

            <div style="margin-bottom: 20px; font-size: 2rem; color: #ffd700;">
                @RenderStars(review.Rating)
            </div>

            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; font-style: italic; color: rgba(255,255,255,0.9);">
                "@review.Feedback"
            </div>

            <EditForm method="post" Model="review" OnValidSubmit="DeleteReview" FormName="delete" Enhance>
                <div class="card-actions" style="justify-content: center; margin-top: 30px; gap: 15px;">

                    <a href="@($"/reviews/{review.BookingId}")" class="btn-action btn-reschedule" style="text-align: center; max-width: 150px;">
                        Cancel
                    </a>

                    <button type="submit" class="btn-action btn-cancel" disabled="@(review is null)" style="border:none; max-width: 200px;">
                        Confirm Delete
                    </button>

                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    private Review? review;

    [SupplyParameterFromQuery]
    private int ReviewId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        review = await context.Review.FirstOrDefaultAsync(m => m.ReviewId == ReviewId);

        if (review is null)
        {
            NavigationManager.NavigateTo("notfound");
        }
    }

    private async Task DeleteReview()
    {
        using var context = DbFactory.CreateDbContext();
        context.Review.Remove(review!);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo($"/reviews/{review.BookingId}");
    }

    private string RenderStars(double rating)
    {
        int r = (int)Math.Round(rating);
        return new string('★', r) + new string('☆', 5 - r);
    }
}