@page "/reviews/details"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using HealthIsWealth.Domain
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDbContextFactory<HealthIsWealth.Data.HealthIsWealthContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Review Details</PageTitle>

<div class="bookings-container">

    <div class="bookings-header">
        <h1>Review Details</h1>
        <p>Full feedback view</p>
    </div>

    @if (review is null)
    {
        <div class="text-center mt-5" style="color: white;">
            <p>Loading...</p>
        </div>
    }
    else
    {
        <div class="booking-card" style="display: block; max-width: 700px; margin: 0 auto;">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
                <h5 style="margin: 0; color: white;">Booking #@review.BookingId</h5>
                <div class="star-rating" title="@review.Rating / 5">
                    @RenderStars(review.Rating)
                </div>
            </div>

            <div class="mb-4">
                <label style="font-size: 0.8rem; text-transform: uppercase; color: rgba(255,255,255,0.7); font-weight: bold; margin-bottom: 5px; display: block;">Feedback</label>
                <div style="padding: 20px; background: rgba(0,0,0,0.15); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                    <p style="margin: 0; font-size: 1.1rem; font-style: italic; color: white; line-height: 1.6;">
                        "@review.Feedback"
                    </p>
                </div>
            </div>

            <div class="mb-4">
                <label style="font-size: 0.8rem; text-transform: uppercase; color: rgba(255,255,255,0.7); font-weight: bold; margin-bottom: 10px; display: block;">Written By</label>

                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 50px; width: fit-content; padding-right: 25px;">
                    <div style="width: 40px; height: 40px; background-color: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: #333;">
                        👤
                    </div>

                    <div>
                        @if (review.User != null)
                        {
                            <div style="font-weight: bold; color: white;">@review.User.FirstName @review.User.LastName</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">@review.User.Email</div>
                        }
                        else
                        {
                            <div style="font-weight: bold; color: white;">Unknown User</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">ID: @review.UserId</div>
                        }
                    </div>
                </div>
            </div>

            <div class="card-actions" style="margin-top: 30px;">
                <a href="@($"/reviews/{review.BookingId}")" class="btn-action btn-reschedule" style="text-align: center;">
                    ← Back to List
                </a>

                @if (review.UserId == currentUserId)
                {
                    <a href="@($"/reviews/edit?reviewid={review.ReviewId}")" class="btn-action btn-details" style="text-align: center;">
                        Edit Review
                    </a>
                }
            </div>

        </div>
    }
</div>

@code {
    private Review? review;
    private string? currentUserId;

    // FIX 1: Add (Name = "reviewid") to ensure it matches the lowercase query string ?reviewid=...
    [SupplyParameterFromQuery(Name = "reviewid")]
    public int ReviewId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        // Include User so we can display their Name/Email
        review = await context.Review
            .Include(r => r.User)
            .FirstOrDefaultAsync(m => m.ReviewId == ReviewId);

        if (review is null)
        {
            // If ID is wrong or not found, redirect
            NavigationManager.NavigateTo("notfound");
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            currentUserId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        }
    }

    private MarkupString RenderStars(double rating)
    {
        int roundedRating = (int)Math.Round(rating);
        var stars = "";
        for (int i = 1; i <= 5; i++)
        {
            stars += (i <= roundedRating) ? "★" : "☆";
        }
        // Added styling to make stars Gold
        return new MarkupString($"<span style='color:#ffd700; font-size: 1.2rem;'>{stars}</span>");
    }
}